version: '3.8'  

services:  
  backend:  
    build: ./backend  
    container_name: api-backend  
    labels:  
      - "monitoring.role=backend"  
      - "monitoring.name=api-backend"  
    restart: unless-stopped  
    env_file:  
      - ./backend/.env  
    environment:  
      - NODE_ENV=production  
      - PORT=4000  
      - MONGO_URL=mongodb://mongo:27017/webpage-portfolio  
      - CORS_ORIGINS=https://stealthdebug.org,https://www.stealthdebug.org  
    networks:  
      - app-network  
    expose:  
      - "4000"  
    depends_on:  
      - mongo  

  frontend:  
    build: ./frontend  
    container_name: react-frontend  
    labels:  
      - "monitoring.role=frontend"  
      - "monitoring.name=react-frontend"  
    restart: unless-stopped  
    networks:  
      - app-network  
    expose:  
      - "80"  

  nginx:  
    image: nginx:alpine  
    container_name: nginx-proxy
    labels:  
      - "monitoring.role=proxy"  
      - "monitoring.name=nginx-proxy"    
    restart: unless-stopped  
    ports:  
      - "80:80"  
      - "443:443"  
    volumes:  
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro  
      - ./certs:/etc/nginx/certs:ro  
    depends_on:  
      - backend  
      - frontend  
    networks:  
      - app-network  

  mongo:  
    image: mongo:6  
    container_name: mongo-db  
    labels:  
      - "monitoring.role=database"  
      - "monitoring.name=mongo-db"  
    restart: unless-stopped  
    environment:  
      - MONGO_INITDB_DATABASE=webpage-portfolio  
    volumes:  
      - mongo-data:/data/db  
    ports:  
      - "27017:27017"  
    networks:  
      - app-network  

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    expose:
      - "9100"
    networks:
      - monitoring

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    expose:
      - "9090"
    networks:
      - monitoring

networks:  
  app-network:  
    driver: bridge  

volumes:  
  mongo-data:  
    driver: local  